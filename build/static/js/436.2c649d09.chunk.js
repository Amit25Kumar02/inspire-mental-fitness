"use strict";(self.webpackChunkinspire_mental_fitness=self.webpackChunkinspire_mental_fitness||[]).push([[436],{38436:(e,t,n)=>{n.r(t),n.d(t,{default:()=>u});var a=n(9950),o=(n(31598),n(44414));const r={key:"cGZic3BvcnRzQGdtYWlsLmNvbQ:LWF2x-aB-y7l_6EBNtmvD",url:"https://api.d-id.com"},s=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection,c=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;try{const a=await fetch(e,t);return!a.ok&&n>0?(await new Promise(e=>setTimeout(e,800*(Math.random()+1))),c(e,t,n-1)):a}catch(a){if(n>0)return await new Promise(e=>setTimeout(e,800*(Math.random()+1))),c(e,t,n-1);throw a}},i=(0,a.forwardRef)((e,t)=>{var n,i;const u=null===e||void 0===e||null===(n=e.agentData)||void 0===n?void 0:n.agent_id,l=((null===e||void 0===e?void 0:e.aiResponse)||"").replace(/ChatType:\s*\w+\s*/i,"").replace(/<[^>]*>/g,"").replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF]|\u24C2|\uFE0F|\u200D|\u23CF|\u23E9|\u231A|\u3030|\u303D|\u3297|\u3299|\u25AA|\u25AB|\u25B6|\u25C0|\u25FB|\u25FC|\u25FD|\u25FE|\u2600-\u26FF|\u2B05|\u2B06|\u2B07|\u2B1B|\u2B1C|\u2B50|\u2B55|\u2934|\u2935|\u27A1|\u2194|\u2195|\u2196|\u2197|\u2198|\u2199)/g,"").replace(/[^a-zA-Z0-9\s]/g,"").replace(/\s+/g," ").trim(),d=null===e||void 0===e||null===(i=e.agentData)||void 0===i?void 0:i.image,p=(0,a.useRef)(null),h=(0,a.useRef)(null),f=(0,a.useRef)(null),y=(0,a.useRef)(null),w=(0,a.useRef)(null),[m,g]=(0,a.useState)(!1),[v,C]=(0,a.useState)(!1),[B,k]=(0,a.useState)(!1),[F,D]=(0,a.useState)(!1),[S,b]=(0,a.useState)(!1);(0,a.useImperativeHandle)(t,()=>({triggerSpeak:async e=>{m&&await R(e)},isConnected:()=>m})),(0,a.useEffect)(()=>()=>{try{var e;null===(e=h.current)||void 0===e||e.close()}catch(t){console.error("Cleanup error:",t)}},[]),(0,a.useEffect)(()=>{!u||B||F||T()},[u,B,F]),(0,a.useEffect)(()=>{m&&l&&R(l)},[l,m]);const T=async()=>{try{D(!1),await E(),k(!0)}catch(e){console.error("Initialization error:",e),D(!0)}},A=()=>{b(!0),C(!0)},E=async()=>{if(!r||!u)throw new Error("API config or agent ID missing");try{const t=await fetch("".concat(r.url,"/agents/").concat(u),{method:"GET",headers:{Authorization:"Basic ".concat(r.key.replace(/^Basic\s*/i,"")),"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch agent info: "+t.status);const n={compatibility_mode:"on",fluent:!0},a=await c("".concat(r.url,"/agents/").concat(u,"/streams"),{method:"POST",headers:{Authorization:"Basic ".concat(r.key.replace(/^Basic\s*/i,"")),"Content-Type":"application/json"},body:JSON.stringify(n)});if(!a.ok)throw new Error("Failed to create stream: "+a.status);const o=await a.json(),{id:i,session_id:l,offer:d,ice_servers:m}=o;y.current=i,w.current=l;const v=function(){const e=new s({iceServers:arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]});h.current=e;const t=new MediaStream;p.current&&(p.current.srcObject=t,p.current.playsInline=!0,p.current.autoplay=!0,p.current.muted=!1),e.ontrack=e=>{var n,a,o;null===(n=e.streams)||void 0===n||null===(a=n[0])||void 0===a||null===(o=a.getTracks())||void 0===o||o.forEach(e=>t.addTrack(e));try{var r;null===(r=p.current)||void 0===r||r.play().catch(()=>{})}catch(s){}},e.onconnectionstatechange=()=>{const t=e.connectionState;"connected"===t&&g(!0),["disconnected","closed","failed"].includes(t)&&(g(!1),D(!0),b(!1),C(!1))};const n=e.createDataChannel("JanusDataChannel");return n.onopen=()=>console.log("Data channel open"),n.onclose=()=>console.log("Data channel closed"),f.current=n,e}(m||[]);let B=d;"string"===typeof d&&(B={type:"offer",sdp:d});try{await v.setRemoteDescription(B)}catch(e){const t=d.sdp||("string"===typeof d?d:"");await v.setRemoteDescription({type:"offer",sdp:t})}const k=await v.createAnswer();return await v.setLocalDescription(k),await fetch("".concat(r.url,"/agents/").concat(u,"/streams/").concat(i,"/sdp"),{method:"POST",headers:{Authorization:"Basic ".concat(r.key.replace(/^Basic\s*/i,"")),"Content-Type":"application/json"},body:JSON.stringify({answer:k,session_id:l})}),g(!0),!0}catch(e){throw console.error("Connection error:",e),e}},R=async t=>{if(r&&y.current&&w.current&&t)try{var n;if(200===(await c("".concat(r.url,"/agents/").concat(u,"/streams/").concat(y.current),{method:"POST",headers:{Authorization:"Basic ".concat(r.key.replace(/^Basic\s*/i,"")),"Content-Type":"application/json"},body:JSON.stringify({script:{type:"text",input:t},session_id:w.current})})).status)null===(n=e.onSpeakStart)||void 0===n||n.call(e,t),b(!0)}catch(a){console.error("Speak error:",a)}else console.error("Cannot speak: missing required parameters")};return(0,o.jsxs)("div",{className:"bg-white rounded-xl overflow-hidden shadow-lg h-100 position-relative",style:{minHeight:"490px",maxHeight:"490px"},children:[(0,o.jsx)("img",{src:d,alt:"Coach Avatar",className:"position-absolute",style:{zIndex:1,display:v?"none":"block",height:"80%",objectFit:"cover",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}}),(0,o.jsx)("video",{ref:p,playsInline:!0,autoPlay:!0,muted:!0,className:"position-absolute top-0 start-0 w-100 h-100 object-cover",style:{zIndex:2,display:S?"block":"none"},onLoadedData:A,onPlaying:A,onError:()=>{D(!0),b(!1),C(!1)}})]})});i.displayName="Avatar";const u=i}}]);